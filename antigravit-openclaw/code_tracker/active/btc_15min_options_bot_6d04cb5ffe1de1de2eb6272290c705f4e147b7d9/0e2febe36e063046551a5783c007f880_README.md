ïž# BTC 1-Hour Binary Options Trading Bot for Polymarket

## Overview

This is a quantitative automated trading system for Polymarket's 1-hour BTC "Up/Down" binary options markets. The bot calculates fair value probabilities using Geometric Brownian Motion (GBM) and executes trades when market prices diverge from the calculated fair value.

**âš ï¸ IMPORTANT:** This bot is for educational and research purposes. Trading involves substantial risk. See `PROJECT_JOURNEY_AND_INSIGHTS.md` for honest assessment and recommendations.

**ðŸ“Š Performance:** Optimized to 66-80% faster execution (1500ms â†’ 300-500ms per cycle) through intelligent caching and architecture improvements.

## System Architecture

The bot consists of 4 core modules plus advanced features:

### Core Modules

#### Module 1: Chainlink Data Harvester (`module1_chainlink_harvester.py`)
- Connects to Polygon blockchain via Web3
- Queries Chainlink BTC/USD price feed smart contracts
- Downloads historical price data for volatility modeling
- Resamples sporadic ticks into structured OHLC data
- Saves data to CSV for statistical analysis

#### Module 2: Market Data Orchestrator (`module2_market_orchestrator.py`)
- Monitors Polymarket's Gamma API for new markets
- Discovers active 1-hour BTC "Up/Down" markets
- Auto-detects market types and extracts strike prices
- Parses various question formats (explicit strike vs. start/end comparison)
- Provides market parameters (token IDs, timing) to execution engine

#### Module 3: Fair Value Pricing Engine (`module3_pricing_engine.py`)
- Implements Geometric Brownian Motion (GBM) pricing model
- Calculates real-world probability P(S_T > K) using Black-Scholes framework
- Supports multiple volatility calculation methods (volume-weighted, Garman-Klass, fixed)
- Uses real-world drift (Î¼) from historical data
- Returns fair value for "Up" and "Down" outcomes
- **Optimized:** BS calculations cached to prevent redundant computation

#### Module 4: CLOB Execution Engine (`module4_execution_engine.py`)
- Integrates with Polymarket CLOB (Central Limit Order Book)
- Places and manages limit/market orders
- Handles order cancellation and fill tracking
- WebSocket integration for real-time order book updates
- Proper signature handling (signature_type=2, funder=PROXY_ADDRESS)

### Advanced Features

#### Position Syncing (`main_bot_optimized.py`)
- **Critical Fix:** Fetches positions from Polymarket Data API
- Syncs internal tracking with real API positions every 30 seconds
- Prevents position drift and handles bot restarts gracefully
- Uses caching for performance (30s TTL, invalidated after orders)

#### Multi-Timeframe Indicators (`indicator_filters.py`)
- Technical analysis across 1h, 5m, 15m timeframes
- ATR (volatility regime detection)
- RSI (momentum/overbought-oversold)
- Bollinger Bands (price extremes)
- ADX (trend strength)
- Volume-weighted and Garman-Klass volatility
- **Optimized:** 5-minute candles cached for 60 seconds

#### Amplification Strategies
- **Price Velocity:** Boosts edge when momentum favors position
- **Rubber Band:** Mean reversion signals during extremes
- Safety filters: ATR check, ADX filter, volume confirmation, cooldown periods

#### Real-Time Price Feeds (`fast_price_fetcher.py`)
- WebSocket integration with Binance for sub-second BTC price updates
- Automatic reconnection logic for dropped connections
- Fallback to HTTP polling if WebSocket fails

#### Order Cancellation Management (`order_cancellation_integration.py`)
- Tracks open limit orders across markets
- Automated cleanup of stale orders
- Prevents position drift from unfilled orders

## Prerequisites

### Software Requirements
- Python 3.10 or higher
- Polygon RPC access (Infura, Alchemy, or public RPC)
- Polymarket account with API credentials
h
### Python Packages
```bash
pip install -r requirements.txt
```

### Required Accounts
- Polygon wallet (EOA) with private key
- Polymarket API credentials (API Key, Secret, Passphrase)
- MATIC tokens (for gas fees on Polygon)
- USDC.e tokens (for trading)

## Installation & Setup

### Prerequisites

#### System Requirements
- **Python 3.10 or higher** (check with `python --version`)
- **Git** (for cloning the repository)
- **Internet connection** (for API calls and data downloads)

#### Required Accounts & Tokens
- **Polygon wallet** with private key and proxy address
- **Polymarket account** with API credentials (API Key, Secret, Passphrase)
- **MATIC tokens** in your EOA wallet (for gas fees)
- **USDC.e tokens** in your proxy wallet (for trading)

### Step-by-Step Installation

#### 1. Clone the Repository
```bash
git clone https://github.com/JohnRovieSegubre/btc-15min-options-bot-private.git
cd btc-15min-options-bot-private
```

#### 2. Set Up Python Virtual Environment
```bash
# Create virtual environment
python -m venv .venv

# Activate virtual environment
# On Windows:
.venv\Scripts\activate
# On macOS/Linux:
# source .venv/bin/activate
```

#### 3. Install Python Dependencies
```bash
pip install -r requirements.txt
```

#### 4. Configure Environment Variables
```bash
# Copy the example environment file
cp .env.example .env

# Edit .env with your credentials (use any text editor)
# Required variables:
# POLYGON_RPC_URL - Your Polygon RPC endpoint
# OWNER_PRIVATE_KEY - Your wallet private key
# PROXY_ADDRESS - Your Polymarket proxy address
# CLOB_API_KEY - Polymarket API key
# CLOB_SECRET - Polymarket API secret
# CLOB_PASSPHRASE - Polymarket API passphrase

# Optional variables:
# SIGMA_METHOD - "volume_weighted" (default) or "fixed"
# FIXED_SIGMA - Fixed sigma value when using fixed method (default: 0.02)
# TRADE_SIZE - Trade size in USDC (default: 2.0)
# DESIRED_EDGE - Minimum edge percentage (default: 0.005)
```

#### 5. Download Historical Price Data
```bash
# Run the Chainlink data harvester
python module1_chainlink_harvester.py

# Select option 1 to download new data
# This creates chainlink_btc_history.csv (takes 5-10 minutes)
```

#### 6. Calculate Volatility Parameters
```bash
# Process historical data and calculate model parameters
python calculate_volatility.py

# This creates model_parameters.json with sigma (Ïƒ) and mu (Î¼)
```

#### 7. Test the Bot (Optional but Recommended)
```bash
# Test individual modules first
python module3_pricing_engine.py    # Test pricing calculations
python module2_market_orchestrator.py  # Test market discovery
python module4_execution_engine.py  # Test execution (no real trades)

# Run in test mode (no real trades)
python main_bot_optimized.py
```

#### 8. Run the Live Trading Bot
```bash
# Start live trading
python main_bot_optimized.py

# The bot will:
# - Monitor for active 1-hour BTC markets
# - Calculate fair values using real-time data
# - Execute trades when edges are detected
```

### Getting Polymarket API Credentials

1. Go to [Polymarket.com](https://polymarket.com)
2. Connect your wallet
3. Navigate to **Settings > API**
4. Click **"Generate New API Key"**
5. **Save the credentials immediately** (API Secret is shown only once!)
6. Add them to your `.env` file

### Setting Up Wallet Allowances

Before trading, you need to approve Polymarket (CLOB) to spend your stable tokens (usually USDC):

```bash
# Manual setup (recommended):
# 1) Identify the stable token address on Polygon (e.g. USDC: 0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174)
# 2) Identify the Polymarket/CLOB spender contract address (ask Polymarket or check their docs)
# 3) From your proxy wallet, call `approve(spender, amount)` (or `MaxUint256` to avoid repeat approvals)
```

Automated option (opt-in):

- You can enable automatic approval by adding these env vars to your `.env` file:

```
STABLE_TOKEN_ADDRESS=0x...                     # Stable token used for trading (USDC on Polygon)
POLYMARKET_CLOB_SPENDER_ADDRESS=0x...          # Spender contract used by Polymarket/CLOB
AUTO_APPROVE_ALLOWANCE=false                    # Set to true to auto-approve using OWNER_PRIVATE_KEY
```

When `AUTO_APPROVE_ALLOWANCE` is enabled (now `true` by default in the provided `.env`), the bot will check allowance before BUY orders and try to `approve(spender, MaxUint256)` if needed. If `POLYMARKET_CLOB_SPENDER_ADDRESS` is not set, the bot will attempt a best-effort discovery of a spender address from the authenticated CLOB client and use it if it looks like a valid hex address. Use caution â€” this requires that `OWNER_PRIVATE_KEY` can sign approvals for the wallet holding stable tokens.

If you prefer to skip allowance checks (assume prerequisites are already set on-chain), set `ALLOWANCE_PREFLIGHT_ENABLED=false` in your environment or `.env` file. This will bypass both the startup allowance preflight and per-order allowance checks (use with care).

### Verification Checklist

Before running with real money, verify:

- [ ] Python 3.10+ installed: `python --version`
- [ ] Virtual environment activated: `which python` should show `.venv` path
- [ ] Dependencies installed: `pip list` shows required packages
- [ ] `.env` file configured with all required variables
- [ ] `chainlink_btc_history.csv` exists (historical data downloaded)
- [ ] `model_parameters.json` exists (volatility calculated)
- [ ] MATIC balance in EOA wallet (>0.1 MATIC recommended)
- [ ] USDC.e balance in proxy wallet (for trading)
- [ ] Polymarket allowances set up
- [ ] Test run completed successfully

## Sigma Method Configuration

The bot supports two methods for calculating volatility (Ïƒ) used in fair value calculations:

### Volume-Weighted Sigma (Default)
```bash
# Uses real-time OHLCV data to calculate dynamic volatility
SIGMA_METHOD=volume_weighted
```
- âœ… **Dynamic**: Adapts to current market conditions
- âœ… **Accurate**: Uses actual trading volume data
- âŒ **Data Dependent**: Requires reliable OHLCV feeds

### Fixed Constant Sigma
```bash
# Uses a fixed volatility value
SIGMA_METHOD=fixed
FIXED_SIGMA=0.02  # 20% annualized volatility
```
- âœ… **Stable**: Consistent behavior across runs
- âœ… **Predictable**: Good for testing and backtesting
- âŒ **Static**: Doesn't adapt to market changes

### Switching Methods

```bash
# Windows
set SIGMA_METHOD=fixed
set FIXED_SIGMA=0.015

# Linux/Mac
export SIGMA_METHOD=fixed
export FIXED_SIGMA=0.015

# Then restart the bot
python main_bot_optimized.py
```

See `SIGMA_METHOD_GUIDE.md` for detailed configuration examples.

## How It Works

### Fair Value Calculation

The bot uses Geometric Brownian Motion to model BTC price movements:

```
S_T = S_0 * exp((Î¼ - 0.5ÏƒÂ²)T + ÏƒW_T)
```

Where:
- `S_0` = Current BTC price (from RTDS)
- `K` = Strike price (from market question)
- `T` = Time to expiry (in years)
- `Ïƒ` = Annualized volatility (from historical data)
- `Î¼` = Annualized drift (from historical data)

The probability of "Up" outcome: **P(S_T > K) = N(d2)**

Where:
```
d1 = [ln(S/K) + (Î¼ + 0.5ÏƒÂ²)T] / (ÏƒâˆšT)
d2 = d1 - ÏƒâˆšT
```

### Trading Logic

**Taker Strategy (Immediate Execution):**
- BUY signal: `FV_Up > Best_Ask + Fee + Edge`
- SELL signal: `FV_Up < Best_Bid - Fee - Edge`

**Maker Strategy (Passive Orders):**
- Place GTC limit orders at `FV_Up Â± Edge`
- Cancel/update as fair value changes

## File Structure

```
btc_15min_options_bot/
â”œâ”€â”€ main_bot.py                      # Main orchestrator loop
â”œâ”€â”€ module1_chainlink_harvester.py   # Historical data downloader
â”œâ”€â”€ module2_market_orchestrator.py   # Market discovery service
â”œâ”€â”€ module3_pricing_engine.py        # Fair value calculator
â”œâ”€â”€ module4_execution_engine.py      # Trading bot
â”œâ”€â”€ calculate_volatility.py          # Data processing & volatility
â”œâ”€â”€ config.py                        # Configuration loader
â”œâ”€â”€ utils.py                         # Helper functions
â”œâ”€â”€ requirements.txt                 # Python dependencies
â”œâ”€â”€ .env                            # Environment variables (DO NOT COMMIT)
â”œâ”€â”€ .gitignore                      # Git ignore file
â”œâ”€â”€ chainlink_btc_history.csv       # Historical price data
â”œâ”€â”€ model_parameters.json           # Calculated Ïƒ and Î¼
â”œâ”€â”€ trades_log.csv                  # Trade history
â””â”€â”€ README.md                       # This file
```

## Trading Safety Features

### Risk Management
- Maximum position size limits
- Stop-loss on accumulated losses
- Maximum daily trade count
- Minimum edge threshold before trading

### Monitoring
- Real-time Telegram notifications
- Trade logging to CSV
- P&L tracking per market
- Error alerts and warnings

### Error Handling
- Automatic reconnection to WebSockets
- Fallback RPC endpoints
- Order cancellation on disconnect
- Graceful shutdown on errors

## Mathematical Foundation

### Volatility Calculation
1. Load sporadic Chainlink ticks
2. Resample to 1-hour OHLC bars
3. Calculate log returns: `ln(close_t / close_t-1)`
4. Calculate rolling 24-hour standard deviation
5. Annualize: `Ïƒ = Ïƒ_15m * âˆš35,040`

### Drift Calculation
1. Calculate rolling 24-hour mean of log returns
2. Annualize: `Î¼ = Î¼_15m * 35,040`

### Time to Expiry
Continuously calculated as:
```python
T = (T_end - T_now).total_seconds() / (365 * 24 * 60 * 60)
```

## Performance Metrics

The bot tracks:
- Win rate (%)
- Average profit per trade
- Sharpe ratio
- Maximum drawdown
- Total P&L (USDC)
- Edge capture rate

## Important Notes

### Polymarket-Specific Details
1. **Proxy Wallet System**: Polymarket uses EOA + Proxy architecture
   - EOA signs transactions (use `signature_type=2`)
   - Proxy holds funds (use `funder=PROXY_ADDRESS`)
   
2. **Data Sources**: 
   - Live prices: Use RTDS (not RPC polling) to avoid latency
   - Market data: Query Gamma API for market discovery
   
3. **Token IDs**: Each outcome has unique `clobTokenId`:
   - "Up" (Yes) outcome: First token ID
   - "Down" (No) outcome: Second token ID

### Gas & Fees
- MATIC required in EOA for transaction gas
- USDC.e required in Proxy for trading
- Taker fee: ~0.5% per trade
- Maker rebate: May earn rebates for providing liquidity

### Market Timing
- Markets last exactly 1 hour
- Bot should start trading at `T_start`
- Cancel all orders at `T_end`
- Wait for settlement before next market

## Troubleshooting

### Common Errors

**"not enough balance / allowance"**
- Ensure USDC.e is in Proxy wallet (not EOA)
- Run allowance setup: See `POLYMARKET_BOT_SETUP_GUIDE.txt`

**"Connection timeout"**
- Use fallback RPC: Try different Polygon endpoints
- Check internet connection
- Verify WebSocket connectivity

**"Invalid signature"**
- Verify API credentials match your wallet
- Check `signature_type=2` and `funder=PROXY_ADDRESS`
- Regenerate API credentials if needed

**"No asks/bids available"**
- Market may have low liquidity
- Wait for market makers to post orders
- Consider becoming a maker yourself

## Development Roadmap

### Phase 1 (Current)
- [x] Chainlink data harvesting
- [x] Volatility/drift calculation
- [x] Fair value pricing engine
- [x] Basic taker execution

### Phase 2 (Next)
- [ ] Maker order management
- [ ] WebSocket live feeds integration
- [ ] Multi-market support
- [ ] Position tracking

### Phase 3 (Future)
- [ ] Machine learning volatility prediction
- [ ] Order book analysis
- [ ] Portfolio optimization
- [ ] Advanced risk management

## Resources

### Documentation
- [Polymarket Developer Docs](https://docs.polymarket.com)
- [Chainlink Data Feeds](https://docs.chain.link/data-feeds)
- [py-clob-client GitHub](https://github.com/Polymarket/py-clob-client)

### Research Papers
- Black-Scholes-Merton Option Pricing
- Geometric Brownian Motion
- Statistical Arbitrage in Prediction Markets

## License

MIT License - See LICENSE file for details

## ðŸ“š Additional Documentation

### Comprehensive Project Documentation
- **`PROJECT_JOURNEY_AND_INSIGHTS.md`** - Complete development journey, lessons learned, honest assessment, and recommendations
- **`QUICK_REFERENCE.md`** - Quick reference for common operations
- **`QUICKSTART.md`** - Rapid setup guide
- **`OPTIMIZATION_SUMMARY.md`** - Performance optimization details
- **`UP_DOWN_MARKET_STRATEGY.md`** - Strategy documentation

### Key Topics Covered in Project Journey Doc:
- Complete development timeline and evolution
- Performance optimization deep-dive (66-80% faster)
- Critical bug fixes and their solutions
- Position syncing implementation (Data API vs CLOB)
- Advanced strategies (Price Velocity, Rubber Band)
- Honest assessment of strengths and limitations
- Trading vs. technical learning value
- Recommendations for safe operation

## âš ï¸ Important Disclaimers

### Risk Warning
**This bot is for EDUCATIONAL AND RESEARCH PURPOSES ONLY.**

- âŒ NOT a guaranteed profit system
- âŒ NOT financial advice
- âŒ NOT suitable for all investors
- âŒ Trading involves substantial risk of loss
- âŒ You may lose your entire investment
- âŒ Past performance does not guarantee future results

### Technical Limitations
The bot calculates **theoretical** fair values based on:
- Historical price data (which may not predict future movements)
- Simplified mathematical models (GBM assumptions may not hold)
- Technical indicators (which can give false signals)
- Market conditions (which can change rapidly and unpredictably)

**Real-world factors the model DOES NOT account for:**
- Order book liquidity and market impact
- Slippage on larger orders
- Competition from other bots
- News events and black swan occurrences
- Blockchain congestion and gas spikes
- API downtime or data quality issues

### Operational Requirements
- âœ… Start with SMALL amounts ($1-2 per trade)
- âœ… Monitor intensely during initial runs
- âœ… Set hard loss limits and position caps
- âœ… Understand you may lose money even with "edge"
- âœ… Read `PROJECT_JOURNEY_AND_INSIGHTS.md` for honest assessment

**The real value of this project is the learning experience, not trading profits.**

## ðŸŽ¯ Project Goals

### What This Project Achieves:
âœ… Demonstrates quantitative finance concepts in production  
âœ… Shows proper software architecture and optimization techniques  
âœ… Provides hands-on experience with DeFi/blockchain integration  
âœ… Teaches debugging, profiling, and performance tuning  
âœ… Illustrates real-world trading system challenges  

### What This Project Does NOT Guarantee:
âŒ Profitable trading results  
âŒ Consistent returns  
âŒ Risk-free operation  
âŒ Suitability for your capital or risk tolerance  

**If you're looking for guaranteed profits, this is not it. If you're looking to learn quantitative trading system development, this is excellent.**

## ðŸ¤ Support & Community

For issues, questions, or contributions:
- ðŸ“– Read `PROJECT_JOURNEY_AND_INSIGHTS.md` first
- ðŸ› Open an issue on GitHub for bugs
- ðŸ’¬ Check Polymarket Discord community
- ðŸ“š Review existing documentation files

## ðŸ™ Acknowledgments

**Built through an AI-Human collaboration**, demonstrating:
- Iterative problem-solving and debugging
- Performance profiling and optimization
- Production-ready system design
- Honest assessment of capabilities and limitations

### Technologies Used:
- **web3.py** - Blockchain interaction
- **pandas/numpy/scipy** - Quantitative analysis
- **py-clob-client** - Polymarket trading
- **requests** - API integration
- **websocket-client** - Real-time data feeds

### Conceptual Foundation:
Based on quantitative finance principles:
- Geometric Brownian Motion (GBM)
- Black-Scholes option pricing framework
- Real-world probability modeling
- Technical analysis and market microstructure

---

**ðŸ“– For the complete story, honest critique, and detailed recommendations, read: `PROJECT_JOURNEY_AND_INSIGHTS.md`**

**Remember: The best traders combine technical skill with intellectual humility. Trade safely! ðŸš€**
ïž"(6d04cb5ffe1de1de2eb6272290c705f4e147b7d92@file:///c:/Users/rovie%20segubre/btc_15min_options_bot/README.md:6file:///c:/Users/rovie%20segubre/btc_15min_options_bot