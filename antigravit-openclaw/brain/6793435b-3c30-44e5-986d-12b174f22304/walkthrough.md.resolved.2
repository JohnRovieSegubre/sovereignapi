# Walkthrough: The First Real Sale (L402 Verified)

**Objective:** Prove that the Sovereign Node can sell intelligence to a "Stranger" (External Client) using real cryptographically verified payments.

## 1. The Setup
- **Server:** [gateway_server.py](file:///c:/Users/rovie%20segubre/agent/gateway_server.py) running on Port 8000.
- **Tunnel:** `ngrok` exposing the local port to `https://indecomposable-adelia-impolitely.ngrok-free.dev`.
- **Payment Layer:** Alby API (Real Settlement Verification).

## 2. The Transaction Flow (Manual Verification)

### Phase A: The Challenge
The client (Stranger) requests a completion using `curl`:
```bash
curl -i -X POST https://indecomposable-adelia-impolitely.ngrok-free.dev/v1/chat/completions ...
```
**Result:** Server returns `402 Payment Required` with a 10-satoshi Lightning Invoice.

### Phase B: The Settlement
The client pays the invoice using a mobile wallet (e.g., Alby). Upon payment, the client receives the **Preimage** (the secret key).

### Phase C: The Delivery
The client resends the request with the `Authorization: L402 <PREIMAGE>:signature` header.

**Gateway Logic:**
1. Hashed the Preimage (SHA256).
2. Checked Alby API for the matching Payment Hash status.
3. Verified "SETTLED".
4. Forwarded request to OpenRouter (DeepSeek-R1).

## 3. Evidence of Success
```json
{
  "id": "gen-1770540296-q87OtgRfnfC6FvZBbhln",
  "provider": "Novita",
  "model": "deepseek/deepseek-r1",
  "choices": [
    {
      "message": {
        "role": "assistant",
        "content": "Hello! ðŸ‘‹ It's wonderful to connect with you... I'm all yours. ðŸŒŸ"
      }
    }
  ],
  "usage": {
    "total_tokens": 400,
    "cost": 0.0009856
  }
}
```

## 4. The Casino Model (Mint/Spend/Change) - SUCCESS
**Objective:** Replace single-use invoices with a reusable "Bearer Asset" economy.

1.  **Minting (The Cashier):** Called `/v1/admin/mint` with a deposit ID.
    - Received a Macaroon with **1,000 sats**.
2.  **Spending (The Floor):** Called `/v1/chat/completions` with `Authorization: Bearer <TOKEN>`.
    - Gateway verified the signature and balance.
    - Gateway deducted **10 sats**.
3.  **The Change (The Pocket):** Gateway returned a **NEW** Macaroon in the `X-Sovereign-Balance-Token` header.
    -   **New Balance:** **990 sats**.

## 5. Security Verification (Replay Attack) - MITIGATED
**Objective:** Ensure "Stateless" tokens cannot be double-spent.

1.  **Vulnerability Test:** Sent the *same* 1,000 sat token twice.
2.  **Result:**
    -   Spend 1: `200 OK` (Balance deducted).
    -   Spend 2: `403 Forbidden` - `{"error": "Token Already Spent (Replay Detected)"}`.
3.  **Mechanism:** Implemented a "Used Token Blacklist" in [mint_history.json](file:///c:/Users/rovie%20segubre/agent/.agent/data/mint_history.json).

## 6. Conclusion
The node is now a functional **Sovereign Central Bank**. It can "mint" compute credits from any external payment (USDC, Monero, BTC) and issue private, bearer tokens that users can spend instantly.

## 7. Next Steps
- [ ] **Smart Client:** Update [wallet_client.py](file:///c:/Users/rovie%20segubre/agent/wallet_client.py) to automate token rotation (the "Pocket").
- [ ] **Polygon Watcher:** Automate UDSC-to-Token minting.
- [ ] Register on **Moltbook** to advertise multi-currency support.

