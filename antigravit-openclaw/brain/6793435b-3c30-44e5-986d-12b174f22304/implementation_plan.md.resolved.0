# Implementation Plan: The Sovereign Mint (Multi-Currency Support)

**Date:** 2026-02-08
**Status:** ðŸŸ¡ PENDING APPROVAL
**Objective:** Transform the Gateway from a "Vending Machine" (Pay-Per-Request) to a "Central Bank" (Exchange Any Currency â†’ Get Credits).

---

## The "Casino Model" Architecture

```mermaid
graph TD
    subgraph "Payment Channels (The Watchers)"
        BTC[Lightning Watcher]
        ETH[Polygon/USDC Watcher]
        XMR[Monero Watcher]
    end
    
    subgraph "Sovereign Gateway"
        MINT[SovereignMint]
        API[/v1/chat/completions]
        ADMIN[/v1/admin/mint]
    end
    
    USER((User/Agent))

    BTC -->|"POST /mint (20000 sats)"| ADMIN
    ETH -->|"POST /mint (10 USDC = 20000 sats)"| ADMIN
    XMR -->|"POST /mint (0.1 XMR = X sats)"| ADMIN
    
    ADMIN --> MINT
    MINT -->|"Returns Macaroon Token"| USER
    USER -->|"Header: Authorization: Macaroon <TOKEN>"| API
    API -->|"Verify & Deduct"| MINT
```

---

## Phase 1: The Mint Core

### 1.1 Install Dependencies
```bash
pip install pymacaroons
```

### 1.2 Create `SovereignMint` Class
| Feature | Description |
| :--- | :--- |
| `mint(amount_sats, identifier)` | Creates a new Macaroon with a balance. |
| [verify(token)](file:///c:/Users/rovie%20segubre/agent/gateway_server.py#113-152) | Validates signature and returns remaining balance. |
| `spend(token, cost)` | Deducts credits and returns a NEW token with updated balance. |

### 1.3 Add `MINT_SECRET` to Secrets
A new 32-byte key in `.agent/secure/mint_secret.json`.

---

## Phase 2: Gateway Upgrade

### 2.1 New Endpoint: `/v1/admin/mint`
| Parameter | Type | Description |
| :--- | :--- | :--- |
| `amount_sats` | int | Credits to mint. |
| `identifier` | str | Unique deposit ID (e.g., `tx_0x123...`). |
| **Header** | `X-Admin-Key` | The secret key to authorize minting. |

### 2.2 Updated Middleware: `verify_auth_header`
The authorization flow becomes:
1. Check for `Authorization: Macaroon <TOKEN>` â†’ Verify via `SovereignMint`.
2. **Fallback:** Check for `Authorization: L402 <PREIMAGE>:sig` â†’ Verify via Alby (legacy).

---

## Phase 3: Future Watchers (Not This Sprint)

| Watcher | Chain | Status |
| :--- | :--- | :--- |
| `lightning_watcher.py` | Bitcoin LN | âœ… DONE (Alby Webhooks) |
| `polygon_usdc_watcher.py` | Polygon | ðŸ”² TODO |
| `monero_watcher.py` | Monero | ðŸ”² TODO |

---

## Security Considerations

> [!CAUTION]
> **The Admin Key is the Master Key.** If leaked, an attacker can mint infinite credits.
> - Store in `.agent/secure/`.
> - Only allow minting from `localhost` or VPN.

> [!IMPORTANT]
> **Macaroons are Bearer Tokens.** If a user loses their token, they lose their credits.
> - Consider adding a "claim" feature linked to a wallet signature.

---

## Proposed Changes

### [MODIFY] [gateway_server.py](file:///c:/Users/rovie%20segubre/agent/gateway_server.py)
- Add `SovereignMint` class.
- Add `/v1/admin/mint` endpoint.
- Update `verify_l402_header` to also accept Macaroons.

### [NEW] `.agent/secure/mint_secret.json`
- Contains `MINT_SECRET` for signing tokens.

---

## Verification Plan

### Automated Tests
1. Run `python gateway_server.py`.
2. Call `/v1/admin/mint` with the Admin Key.
3. Use the returned Macaroon to call `/v1/chat/completions`.
4. Verify deduction and response.

---

**Awaiting your approval to proceed.**
